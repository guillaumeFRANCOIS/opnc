name: Generate Redoc API Docs

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  generate-docs:
    name: Generate Redoc API Docs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true  # Needed to push

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Redocly CLI
        run: npm install --global @redocly/cli

      - name: Generate docs for all APIs
        run: |
          set +e

          declare -A specs
          specs["ccp"]="specification/apis/ccp/ccp.api.v1.json"
          specs["cps"]="specification/apis/cps/cps.api.v1.json"
          specs["event"]="specification/apis/event/event.api.v1.json"
          specs["pcp"]="specification/apis/pcp/pcp.api.v1.json"
          specs["pki"]="specification/apis/pki/pki.api.v1.json"
          specs["rcp"]="specification/apis/rcp/rcp.api.v1.json"

          BASE_DIR="specifications/api docs by redocly (autogenerated)"
          mkdir -p "$BASE_DIR"

          HOME_INDEX="$BASE_DIR/index.html"
          echo '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>API Documentation</title>' > "$HOME_INDEX"
          echo '<style>
            body { font-family: system-ui, sans-serif; background: #f9f9f9; padding: 2rem; color: #333; }
            h1 { font-size: 2rem; margin-bottom: 1.5rem; }
            ul { list-style: none; padding: 0; }
            li { background: #fff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
            a { text-decoration: none; color: #007acc; font-weight: 500; }
            a:hover { text-decoration: underline; }
          </style></head><body><h1>üìò API Docs</h1><ul>' >> "$HOME_INDEX"

          for api in "${!specs[@]}"; do
            spec_path="${specs[$api]}"
            api_dir="$BASE_DIR/$api"
            mkdir -p "$api_dir"

            echo "üîß Bundling $api..."
            BUNDLE_ERR=$(npx redocly bundle "$spec_path" -o "$api_dir/$api.api.v1.json" 2>&1)
            if [ $? -ne 0 ]; then
              echo -e "::warning::‚ùå Failed to bundle $api:\n$BUNDLE_ERR"
              continue
            fi
            echo "‚úÖ Bundled $api"

            echo "üìò Building docs for $api..."
            DOCS_ERR=$(npx redocly build-docs "$api_dir/$api.api.v1.json" -o "$api_dir/index.html" 2>&1)
            if [ $? -ne 0 ]; then
              echo -e "::warning::‚ö†Ô∏è Failed to generate docs for $api:\n$DOCS_ERR"
              continue
            fi
            echo "‚úÖ Docs generated for $api"

            echo "<li><a href=\"$api/index.html\">$api API</a></li>" >> "$HOME_INDEX"
          done

          echo '</ul></body></html>' >> "$HOME_INDEX"

      - name: Commit and push generated docs
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add "specifications/api docs by redocly (autogenerated)"
          
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "üîÑ Auto-generate Redoc API docs"
            git push
          fi
